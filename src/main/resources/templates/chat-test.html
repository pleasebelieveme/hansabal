<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
</head>
<body>
<h2>âœ… WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>

<div>
  <label>ì ‘ì† ë‹‰ë„¤ì„ (í† í° ê¸°ë°˜)</label><br/>
  <input type="text" id="token" placeholder="JWT accessToken ì…ë ¥" size="80" />
  <button onclick="connect()">Connect</button>
</div>

<hr/>

<div>
  <label>ë°›ëŠ” ì‚¬ëŒ ë‹‰ë„¤ì„</label><br/>
  <input type="text" id="receiver" />
</div>

<div>
  <label>ë³´ë‚¼ ë©”ì‹œì§€</label><br/>
  <input type="text" id="content" />
  <button onclick="sendMessage()">Send</button>
</div>

<hr/>

<div>
  <h3>ğŸ“¥ ìˆ˜ì‹ ëœ ë©”ì‹œì§€</h3>
  <ul id="messages"></ul>
</div>

<!-- SockJS + STOMP CDN -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

<script>
  let stompClient = null;
  let myNickname = null;

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = decodeURIComponent(atob(base64Url).split('').map((c) => {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(base64);
    } catch (e) {
      console.error("âŒ JWT íŒŒì‹± ì‹¤íŒ¨", e);
      return {};
    }
  }

  function connect() {
    const token = document.getElementById("token").value.trim();
    const decoded = parseJwt(token);
    myNickname = decoded.nickname;

    if (!myNickname) {
      alert("ìœ íš¨í•œ JWT í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    const socket = new SockJS("http://localhost:8080/ws?token=" + token);
    stompClient = Stomp.over(socket);

    stompClient.connect({}, (frame) => {
      console.log("ğŸ”Œ ì—°ê²°ë¨:", frame);

      // ë‹‰ë„¤ì„ ê¸°ë°˜ êµ¬ë…
      // const topic = "/topic/messages/" + myNickname;

      stompClient.subscribe("/user/queue/messages", (message) => {
        const msg = JSON.parse(message.body);
        console.log("ğŸ“¥ ë°›ì€ DM:", msg);
        const li = document.createElement("li");
        li.textContent = `[${msg.senderId} â†’ ${msg.receiverId}] ${msg.content}`;
        document.getElementById("messages").appendChild(li);
      });

      console.log("âœ… êµ¬ë… ì™„ë£Œ:", topic);
    }, (error) => {
      console.error("âŒ ì—°ê²° ì‹¤íŒ¨:", error);
    });
  }

  function sendMessage() {
    const receiver = document.getElementById("receiver").value.trim();
    const content = document.getElementById("content").value.trim();

    if (!stompClient || !stompClient.connected) {
      alert("ë¨¼ì € ì—°ê²°ë¶€í„° í•˜ì„¸ìš”");
      return;
    }

    console.log("ğŸ”” ë©”ì‹œì§€ ì „ì†¡: receiver =", receiver, "content =", content);

    stompClient.send("/app/dm", {}, JSON.stringify({
      receiverNickname: receiver,
      content: content
    }));
  }
</script>
</body>
</html>
